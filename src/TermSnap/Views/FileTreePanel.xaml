<UserControl x:Class="TermSnap.Views.FileTreePanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:models="clr-namespace:TermSnap.Models"
             Background="{DynamicResource SurfaceBrush}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- 트리 아이템 스타일 -->
        <Style x:Key="FileTreeItemStyle" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{DynamicResource PrimaryLightBrush}"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
                </Trigger>
                <DataTrigger Binding="{Binding IsHidden}" Value="True">
                    <Setter Property="Opacity" Value="0.6"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- 메인 콘텐츠 -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

        <!-- 헤더 -->
        <Border Grid.Row="0"
                Background="{DynamicResource CardBrush}"
                Padding="8,6"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="FolderOutline"
                                             Width="18" Height="18"
                                             VerticalAlignment="Center"
                                             Foreground="{DynamicResource PrimaryBrush}"/>
                    <TextBlock Text="파일 탐색기"
                               FontWeight="SemiBold"
                               FontSize="12"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               VerticalAlignment="Center"
                               Margin="6,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <!-- 새로고침 -->
                    <Button x:Name="RefreshButton"
                            ToolTip="새로고침"
                            Style="{StaticResource MaterialDesignToolButton}"
                            Width="24" Height="24"
                            Padding="0"
                            Foreground="{DynamicResource TextSecondaryBrush}"
                            Click="RefreshButton_Click">
                        <materialDesign:PackIcon Kind="Refresh" Width="16" Height="16"/>
                    </Button>

                    <!-- 숨김 파일 토글 -->
                    <ToggleButton x:Name="ShowHiddenToggle"
                                  ToolTip="숨김 파일 표시"
                                  Style="{StaticResource MaterialDesignToolForegroundButton}"
                                  Width="24" Height="24"
                                  Padding="0"
                                  Margin="4,0,0,0"
                                  Foreground="{DynamicResource TextSecondaryBrush}"
                                  IsChecked="True"
                                  Click="ShowHiddenToggle_Click">
                        <materialDesign:PackIcon Kind="Eye" Width="16" Height="16"/>
                    </ToggleButton>

                    <!-- 접기 버튼 -->
                    <Button x:Name="CollapseButton"
                            ToolTip="패널 닫기"
                            Style="{StaticResource MaterialDesignToolButton}"
                            Width="24" Height="24"
                            Padding="0"
                            Margin="4,0,0,0"
                            Foreground="{DynamicResource TextSecondaryBrush}"
                            Click="CollapseButton_Click">
                        <materialDesign:PackIcon Kind="ChevronLeft" Width="16" Height="16"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 현재 경로 표시 -->
        <Border Grid.Row="1"
                Background="{DynamicResource SurfaceBrush}"
                Padding="8,4"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Button x:Name="GoUpButton"
                        ToolTip="상위 폴더"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Width="24" Height="24"
                        Padding="0"
                        Foreground="{DynamicResource TextSecondaryBrush}"
                        Click="GoUpButton_Click">
                    <materialDesign:PackIcon Kind="ArrowUp" Width="16" Height="16"/>
                </Button>

                <TextBox x:Name="PathTextBox"
                         Grid.Column="1"
                         FontFamily="Consolas"
                         FontSize="11"
                         VerticalAlignment="Center"
                         Margin="4,0,0,0"
                         BorderThickness="0"
                         Foreground="{DynamicResource TextPrimaryBrush}"
                         Background="Transparent"
                         CaretBrush="{DynamicResource TextPrimaryBrush}"
                         KeyDown="PathTextBox_KeyDown"/>
            </Grid>
        </Border>

        <!-- 파일 트리 -->
        <TreeView x:Name="FileTree"
                  Grid.Row="2"
                  BorderThickness="0"
                  Background="Transparent"
                  VirtualizingStackPanel.IsVirtualizing="True"
                  VirtualizingStackPanel.VirtualizationMode="Recycling"
                  ItemContainerStyle="{StaticResource FileTreeItemStyle}"
                  TreeViewItem.Expanded="FileTree_Expanded"
                  SelectedItemChanged="FileTree_SelectedItemChanged"
                  MouseDoubleClick="FileTree_MouseDoubleClick"
                  PreviewMouseRightButtonDown="FileTree_PreviewMouseRightButtonDown"
                  PreviewKeyDown="FileTree_PreviewKeyDown">

            <TreeView.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="열기" Click="ContextMenu_Open_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="OpenInNew"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="편집" Click="ContextMenu_Edit_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="Pencil"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="터미널에서 열기" Click="ContextMenu_OpenInTerminal_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="Console"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="새 폴더" Click="ContextMenu_NewFolder_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="FolderPlus"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="새 파일" Click="ContextMenu_NewFile_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="FilePlus"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="이름 변경 (F2)" Click="ContextMenu_Rename_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="RenameBox"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="삭제 (Delete)" Click="ContextMenu_Delete_Click" Foreground="{DynamicResource ErrorBrush}">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="Delete" Foreground="{DynamicResource ErrorBrush}"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="복사 (Ctrl+C)" Click="ContextMenu_Copy_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="ContentCopy"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="잘라내기 (Ctrl+X)" Click="ContextMenu_Cut_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="ContentCut"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="붙여넣기 (Ctrl+V)" Click="ContextMenu_Paste_Click" x:Name="PasteMenuItem">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="ContentPaste"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="경로 복사" Click="ContextMenu_CopyPath_Click">
                        <MenuItem.Icon>
                            <materialDesign:PackIcon Kind="ClipboardText"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </ContextMenu>
            </TreeView.ContextMenu>

            <TreeView.ItemTemplate>
                <HierarchicalDataTemplate DataType="{x:Type models:FileTreeItem}"
                                          ItemsSource="{Binding Children}">
                    <StackPanel Orientation="Horizontal" Margin="2">
                        <!-- 로딩 인디케이터 -->
                        <ProgressBar Width="14" Height="14"
                                     Style="{StaticResource MaterialDesignCircularProgressBar}"
                                     IsIndeterminate="True"
                                     Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                                     Margin="0,0,4,0"/>

                        <!-- 아이콘 -->
                        <materialDesign:PackIcon Kind="{Binding Icon}"
                                                 Width="16" Height="16"
                                                 VerticalAlignment="Center"
                                                 Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}">
                            <materialDesign:PackIcon.Style>
                                <Style TargetType="materialDesign:PackIcon">
                                    <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource WarningBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </materialDesign:PackIcon.Style>
                        </materialDesign:PackIcon>

                        <!-- 파일명 -->
                        <TextBlock Text="{Binding Name}"
                                   VerticalAlignment="Center"
                                   Margin="6,0,0,0"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   FontFamily="Segoe UI"/>

                        <!-- 파일 크기 (파일인 경우) -->
                        <TextBlock Text="{Binding SizeFormatted}"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0"
                                   FontSize="10"
                                   Foreground="{DynamicResource TextSecondaryBrush}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>

        <!-- 로딩 오버레이 -->
        <Border Grid.Row="2"
                Background="{DynamicResource BackgroundBrush}"
                Opacity="0.8"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                x:Name="LoadingOverlay">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                             IsIndeterminate="True"
                             Width="32" Height="32"/>
                <TextBlock Text="로딩 중..."
                           Margin="0,8,0,0"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
        </Border>
        </Grid>

        <!-- 오른쪽 리사이즈 그립 (드래그하여 너비 조절) -->
        <Border x:Name="ResizeGrip"
                Grid.Column="1"
                Width="8"
                Background="Transparent"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,0,1,0"
                Cursor="SizeWE"
                MouseLeftButtonDown="ResizeGrip_MouseLeftButtonDown"
                MouseLeftButtonUp="ResizeGrip_MouseLeftButtonUp"
                MouseMove="ResizeGrip_MouseMove"
                ToolTip="드래그하여 너비 조절">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="Transparent"/>
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="{DynamicResource PrimaryHueMidBrush}"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <!-- 시각적 표시 (3개 점) -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <Ellipse Width="3" Height="3" Fill="{DynamicResource MaterialDesignBodyLight}" Margin="0,2"/>
                <Ellipse Width="3" Height="3" Fill="{DynamicResource MaterialDesignBodyLight}" Margin="0,2"/>
                <Ellipse Width="3" Height="3" Fill="{DynamicResource MaterialDesignBodyLight}" Margin="0,2"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
