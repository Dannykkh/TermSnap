using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using TermSnap.Models;
using TermSnap.Services;

namespace TermSnap.Views;

/// <summary>
/// AI ì¥ê¸°ê¸°ì–µ íŒ¨ë„ ì½”ë“œë¹„í•˜ì¸ë“œ (MEMORY.md ê¸°ë°˜)
/// íƒ­ë³„ë¡œ ë…ë¦½ì ì¸ MemoryService ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì§
/// </summary>
public partial class MemoryPanel : UserControl
{
    private readonly MemoryService _memoryService = new();
    private MemoryType? _currentTypeFilter = null;
    private List<MemoryDisplayItem> _allItems = new();

    /// <summary>
    /// íŒ¨ë„ ë‹«ê¸° ìš”ì²­
    /// </summary>
    public event EventHandler? CloseRequested;

    public MemoryPanel()
    {
        InitializeComponent();
        Loaded += MemoryPanel_Loaded;
    }

    private async void MemoryPanel_Loaded(object sender, RoutedEventArgs e)
    {
        await RefreshMemories();
    }

    /// <summary>
    /// ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
    /// </summary>
    public void SetWorkingDirectory(string directory)
    {
        _memoryService.SetWorkingDirectory(directory);
        _ = RefreshMemories();
    }

    /// <summary>
    /// ë©”ëª¨ë¦¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    /// </summary>
    public async Task RefreshMemories()
    {
        try
        {
            var memories = _memoryService.GetAllMemories();

            _allItems = memories.Select(m => new MemoryDisplayItem
            {
                Id = m.Id,
                Content = m.Content,
                Type = m.Type,
                TypeIcon = GetTypeIcon(m.Type),
                TypeName = GetTypeName(m.Type),
                Importance = m.Importance,
                ImportanceText = $"ì¤‘ìš”ë„ {(m.Importance * 100):0}%",
                Source = m.Source,
                HasSource = !string.IsNullOrEmpty(m.Source),
                AccessCount = m.AccessCount,
                AccessInfo = $"ì ‘ê·¼ {m.AccessCount}íšŒ",
                CreatedAt = m.CreatedAt,
                IsAutoGenerated = m.IsAutoGenerated
            }).ToList();

            ApplyFilter();
            UpdateStatistics();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[MemoryPanel] ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }

        await Task.CompletedTask;
    }

    /// <summary>
    /// í•„í„° ì ìš©
    /// </summary>
    private void ApplyFilter()
    {
        // ì´ˆê¸°í™” ì „ì—ëŠ” ë¬´ì‹œ
        if (MemoryList == null || SearchBox == null) return;

        var filtered = _allItems.AsEnumerable();

        // íƒ€ì… í•„í„°
        if (_currentTypeFilter.HasValue)
        {
            filtered = filtered.Where(m => m.Type == _currentTypeFilter.Value);
        }

        // ê²€ìƒ‰ì–´ í•„í„°
        var searchText = SearchBox.Text?.Trim();
        if (!string.IsNullOrEmpty(searchText))
        {
            filtered = filtered.Where(m =>
                m.Content.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (m.Source?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        MemoryList.ItemsSource = filtered.ToList();
    }

    /// <summary>
    /// í†µê³„ ì—…ë°ì´íŠ¸
    /// </summary>
    private void UpdateStatistics()
    {
        // ì´ˆê¸°í™” ì „ì—ëŠ” ë¬´ì‹œ
        if (StatsText == null) return;

        var stats = _memoryService.GetStatistics();
        var hasFile = _memoryService.HasMemoryFile;

        if (hasFile)
        {
            StatsText.Text = $"ì´ {stats.Total}ê°œ ê¸°ì–µ";
        }
        else
        {
            StatsText.Text = "MEMORY.md ì—†ìŒ (ì¶”ê°€ ì‹œ ìƒì„±)";
        }
    }

    private static string GetTypeIcon(MemoryType type) => type switch
    {
        MemoryType.Architecture => "ğŸ—ï¸",
        MemoryType.Pattern => "ğŸ”„",
        MemoryType.Tool => "ğŸ”§",
        MemoryType.Gotcha => "âš ï¸",
        MemoryType.Goal => "ğŸ¯",
        MemoryType.Meta => "ğŸ“",
        _ => "â€¢"
    };

    private static string GetTypeName(MemoryType type) => type switch
    {
        MemoryType.Architecture => "ì•„í‚¤í…ì²˜",
        MemoryType.Pattern => "íŒ¨í„´",
        MemoryType.Tool => "ë„êµ¬",
        MemoryType.Gotcha => "ì£¼ì˜ì‚¬í•­",
        MemoryType.Goal => "ëª©í‘œ",
        MemoryType.Meta => "ë©”íƒ€",
        _ => "ê¸°íƒ€"
    };

    #region Event Handlers

    private void CloseButton_Click(object sender, RoutedEventArgs e)
    {
        CloseRequested?.Invoke(this, EventArgs.Empty);
    }

    private void SearchBox_KeyDown(object sender, KeyEventArgs e)
    {
        if (e.Key == Key.Enter)
        {
            ApplyFilter();
        }
    }

    private void SearchButton_Click(object sender, RoutedEventArgs e)
    {
        ApplyFilter();
    }

    private void TypeFilterCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (TypeFilterCombo.SelectedItem is ComboBoxItem item)
        {
            var tag = item.Tag as string;
            if (string.IsNullOrEmpty(tag))
            {
                _currentTypeFilter = null;
            }
            else if (Enum.TryParse<MemoryType>(tag, out var type))
            {
                _currentTypeFilter = type;
            }
            ApplyFilter();
        }
    }

    private async void RefreshButton_Click(object sender, RoutedEventArgs e)
    {
        _memoryService.LoadFromFile();
        await RefreshMemories();
    }

    private void MemoryList_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        // ì„ íƒ ì‹œ ì¶”ê°€ ë™ì‘ (í•„ìš” ì‹œ)
    }

    private async void DeleteMemory_Click(object sender, RoutedEventArgs e)
    {
        if (sender is Button button && button.Tag is int id)
        {
            var result = MessageBox.Show(
                "ì´ ê¸°ì–µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                "ê¸°ì–µ ì‚­ì œ",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                _memoryService.DeleteMemory(id);
                await RefreshMemories();
            }
        }
    }

    private async void AddButton_Click(object sender, RoutedEventArgs e)
    {
        // ì‘ì—… ë””ë ‰í† ë¦¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê²½ê³ 
        if (_memoryService.MemoryFilePath == null)
        {
            MessageBox.Show(
                "ë¨¼ì € í´ë”ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.",
                "ì•Œë¦¼",
                MessageBoxButton.OK,
                MessageBoxImage.Information);
            return;
        }

        var dialog = new AddMemoryDialog();
        dialog.Owner = Window.GetWindow(this);

        if (dialog.ShowDialog() == true)
        {
            var entry = new MemoryEntry
            {
                Content = dialog.MemoryContent,
                Type = dialog.SelectedType,
                Importance = dialog.Importance,
                IsAutoGenerated = false
            };

            await _memoryService.AddMemory(entry);
            await RefreshMemories();
        }
    }

    private void ExportButton_Click(object sender, RoutedEventArgs e)
    {
        // MEMORY.md íŒŒì¼ ì—´ê¸°
        var filePath = _memoryService.MemoryFilePath;

        if (filePath == null)
        {
            MessageBox.Show(
                "ë¨¼ì € í´ë”ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.",
                "ì•Œë¦¼",
                MessageBoxButton.OK,
                MessageBoxImage.Information);
            return;
        }

        if (!File.Exists(filePath))
        {
            // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
            _memoryService.CreateMemoryFileIfNotExists();
        }

        try
        {
            // ê¸°ë³¸ í¸ì§‘ê¸°ë¡œ ì—´ê¸°
            Process.Start(new ProcessStartInfo
            {
                FileName = filePath,
                UseShellExecute = true
            });
        }
        catch (Exception ex)
        {
            MessageBox.Show(
                $"íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {ex.Message}",
                "ì˜¤ë¥˜",
                MessageBoxButton.OK,
                MessageBoxImage.Error);
        }
    }

    #endregion
}

/// <summary>
/// ë©”ëª¨ë¦¬ í‘œì‹œìš© ì•„ì´í…œ
/// </summary>
public class MemoryDisplayItem
{
    public int Id { get; set; }
    public string Content { get; set; } = string.Empty;
    public MemoryType Type { get; set; }
    public string TypeIcon { get; set; } = string.Empty;
    public string TypeName { get; set; } = string.Empty;
    public double Importance { get; set; }
    public string ImportanceText { get; set; } = string.Empty;
    public string? Source { get; set; }
    public bool HasSource { get; set; }
    public int AccessCount { get; set; }
    public string AccessInfo { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }
    public bool IsAutoGenerated { get; set; }
}
