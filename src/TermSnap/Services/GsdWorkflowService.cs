using System;
using System.Collections.Generic;
using System.IO;
using System.Text;
using System.Text.Json;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using TermSnap.Models;

namespace TermSnap.Services;

/// <summary>
/// GSD (Get-Shit-Done) ì›Œí¬í”Œë¡œìš° ì„œë¹„ìŠ¤
/// .planning/ í´ë” êµ¬ì¡° ìƒì„± ë° ê´€ë¦¬
/// </summary>
public class GsdWorkflowService
{
    private const string PlanningFolder = ".planning";
    private const string ResearchFolder = "research";

    /// <summary>
    /// .planning/ í´ë”ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    /// </summary>
    public static bool HasPlanningFolder(string workingDirectory)
    {
        if (string.IsNullOrEmpty(workingDirectory))
            return false;

        var planningPath = Path.Combine(workingDirectory, PlanningFolder);
        return Directory.Exists(planningPath);
    }

    /// <summary>
    /// GSD ì›Œí¬í”Œë¡œìš° ì´ˆê¸°í™” (.planning/ í´ë” ë° í…œí”Œë¦¿ ìƒì„±)
    /// </summary>
    public static async Task<bool> InitializeAsync(string workingDirectory, string projectName, string? projectDescription = null)
    {
        if (string.IsNullOrEmpty(workingDirectory))
            return false;

        try
        {
            var planningPath = Path.Combine(workingDirectory, PlanningFolder);
            var researchPath = Path.Combine(planningPath, ResearchFolder);

            // í´ë” ìƒì„±
            Directory.CreateDirectory(planningPath);
            Directory.CreateDirectory(researchPath);

            // ê¸°ë³¸ íŒŒì¼ë“¤ ìƒì„±
            await CreateConfigAsync(planningPath, projectName);
            await CreateProjectMdAsync(planningPath, projectName, projectDescription);
            await CreateRoadmapMdAsync(planningPath, projectName);
            await CreateStateMdAsync(planningPath);
            await CreateRequirementsMdAsync(planningPath, projectName);

            return true;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[GsdWorkflowService] Initialize failed: {ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// config.json ìƒì„±
    /// </summary>
    private static async Task CreateConfigAsync(string planningPath, string projectName)
    {
        var config = new GsdConfig
        {
            ProjectName = projectName,
            CreatedAt = DateTime.Now,
            ExecutionMode = "interactive",
            PlanningDepth = "standard",
            GitTracking = true,
            ModelProfile = "balanced"
        };

        var json = JsonSerializer.Serialize(config, new JsonSerializerOptions { WriteIndented = true });
        await File.WriteAllTextAsync(Path.Combine(planningPath, "config.json"), json);
    }

    /// <summary>
    /// PROJECT.md í…œí”Œë¦¿ ìƒì„±
    /// </summary>
    private static async Task CreateProjectMdAsync(string planningPath, string projectName, string? description)
    {
        var template = $@"# {projectName}

## Overview

{description ?? "í”„ë¡œì íŠ¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."}

## Goals

- [ ] ëª©í‘œ 1
- [ ] ëª©í‘œ 2
- [ ] ëª©í‘œ 3

## Tech Stack

- **Frontend**:
- **Backend**:
- **Database**:
- **Infrastructure**:

## Key Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| | | |

## Constraints

- ì œì•½ ì‚¬í•­ 1
- ì œì•½ ì‚¬í•­ 2

## Out of Scope

- ë²”ìœ„ ë°– í•­ëª© 1
- ë²”ìœ„ ë°– í•­ëª© 2

---

*Generated by TermSnap GSD Workflow*
*Created: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, "PROJECT.md"), template, Encoding.UTF8);
    }

    /// <summary>
    /// ROADMAP.md í…œí”Œë¦¿ ìƒì„±
    /// </summary>
    private static async Task CreateRoadmapMdAsync(string planningPath, string projectName)
    {
        var template = $@"# {projectName} - Roadmap

## Progress Overview

| Phase | Name | Status | Progress |
|-------|------|--------|----------|
| 1 | Setup & Foundation | ğŸ”µ Pending | 0% |
| 2 | Core Features | âšª Pending | 0% |
| 3 | Integration & Testing | âšª Pending | 0% |
| 4 | Polish & Deploy | âšª Pending | 0% |

---

## Phase 1: Setup & Foundation

### Objectives
- [ ] í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ì •
- [ ] ê°œë°œ í™˜ê²½ êµ¬ì„±
- [ ] ê¸°ë³¸ ì•„í‚¤í…ì²˜ ìˆ˜ë¦½

### Success Criteria
- í”„ë¡œì íŠ¸ê°€ ë¹Œë“œë˜ê³  ì‹¤í–‰ë¨
- ê¸°ë³¸ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•¨

### Status: ğŸ”µ In Progress

---

## Phase 2: Core Features

### Objectives
- [ ] í•µì‹¬ ê¸°ëŠ¥ 1 êµ¬í˜„
- [ ] í•µì‹¬ ê¸°ëŠ¥ 2 êµ¬í˜„

### Success Criteria
- í•µì‹¬ ê¸°ëŠ¥ì´ ë™ì‘í•¨
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼

### Status: âšª Pending

---

## Phase 3: Integration & Testing

### Objectives
- [ ] í†µí•© í…ŒìŠ¤íŠ¸
- [ ] E2E í…ŒìŠ¤íŠ¸
- [ ] ë²„ê·¸ ìˆ˜ì •

### Success Criteria
- ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
- ì£¼ìš” ë²„ê·¸ ì—†ìŒ

### Status: âšª Pending

---

## Phase 4: Polish & Deploy

### Objectives
- [ ] UI/UX ê°œì„ 
- [ ] ì„±ëŠ¥ ìµœì í™”
- [ ] ë°°í¬

### Success Criteria
- í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ
- ë¬¸ì„œí™” ì™„ë£Œ

### Status: âšª Pending

---

*Generated by TermSnap GSD Workflow*
*Last Updated: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, "ROADMAP.md"), template, Encoding.UTF8);
    }

    /// <summary>
    /// STATE.md í…œí”Œë¦¿ ìƒì„±
    /// </summary>
    private static async Task CreateStateMdAsync(string planningPath)
    {
        var template = $@"# Project State

## Current Position

- **Phase**: 1
- **Step**: discuss
- **Last Updated**: {DateTime.Now:yyyy-MM-dd HH:mm}

## Recent Activity

| Date | Phase | Action | Result |
|------|-------|--------|--------|
| {DateTime.Now:yyyy-MM-dd} | 0 | Project initialized | âœ… |

## Context for Next Session

> ë‹¤ìŒ ì„¸ì…˜ì—ì„œ ì´ì–´ì„œ ì§„í–‰í•  ë‚´ìš©ì„ ì—¬ê¸°ì— ê¸°ë¡í•˜ì„¸ìš”.

## Blockers

- (ì—†ìŒ)

## Notes

- í”„ë¡œì íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
- `/gsd:discuss-phase 1`ìœ¼ë¡œ ì²« ë²ˆì§¸ í˜ì´ì¦ˆë¥¼ ì‹œì‘í•˜ì„¸ìš”.

---

*Generated by TermSnap GSD Workflow*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, "STATE.md"), template, Encoding.UTF8);
    }

    /// <summary>
    /// REQUIREMENTS.md í…œí”Œë¦¿ ìƒì„±
    /// </summary>
    private static async Task CreateRequirementsMdAsync(string planningPath, string projectName)
    {
        var template = $@"# {projectName} - Requirements

## v1.0 (MVP)

### Must Have

| ID | Category | Requirement | Status |
|----|----------|-------------|--------|
| REQ-001 | Core | í•µì‹¬ ê¸°ëŠ¥ 1 | âšª |
| REQ-002 | Core | í•µì‹¬ ê¸°ëŠ¥ 2 | âšª |
| REQ-003 | UI | ê¸°ë³¸ UI | âšª |

### Should Have

| ID | Category | Requirement | Status |
|----|----------|-------------|--------|
| REQ-101 | UX | ì‚¬ìš©ì ê²½í—˜ ê°œì„  | âšª |

## v2.0 (Future)

| ID | Category | Requirement | Notes |
|----|----------|-------------|-------|
| REQ-201 | Feature | ì¶”ê°€ ê¸°ëŠ¥ | í›„ì† ë²„ì „ |

## Out of Scope

- ë²”ìœ„ ë°– í•­ëª© 1
- ë²”ìœ„ ë°– í•­ëª© 2

---

### Status Legend

- âšª Pending
- ğŸ”µ In Progress
- âœ… Complete
- âŒ Blocked
- â¸ï¸ Deferred

---

*Generated by TermSnap GSD Workflow*
*Last Updated: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, "REQUIREMENTS.md"), template, Encoding.UTF8);
    }

    /// <summary>
    /// Phase Context íŒŒì¼ ìƒì„± (discuss ë‹¨ê³„)
    /// </summary>
    public static async Task CreatePhaseContextAsync(string workingDirectory, int phaseNumber, string context)
    {
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);
        var fileName = $"phase-{phaseNumber}-CONTEXT.md";

        var template = $@"# Phase {phaseNumber} - Context

## Discussion Summary

{context}

## Decisions Made

| Topic | Decision | Rationale |
|-------|----------|-----------|
| | | |

## Gray Areas Resolved

-

## Deferred to Later Phases

-

---

*Created: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, fileName), template, Encoding.UTF8);
    }

    /// <summary>
    /// Phase Plan íŒŒì¼ ìƒì„± (plan ë‹¨ê³„)
    /// </summary>
    public static async Task CreatePhasePlanAsync(string workingDirectory, int phaseNumber, int planNumber, string planContent)
    {
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);
        var fileName = $"phase-{phaseNumber}-{planNumber}-PLAN.md";

        var template = $@"# Phase {phaseNumber} - Plan {planNumber}

## Objective

{planContent}

## Tasks

- [ ] Task 1
- [ ] Task 2
- [ ] Task 3

## Files to Modify

| File | Action | Description |
|------|--------|-------------|
| | | |

## Dependencies

- (ì—†ìŒ)

## Verification

- [ ] ë¹Œë“œ ì„±ê³µ
- [ ] í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] ê¸°ëŠ¥ ë™ì‘ í™•ì¸

## Success Criteria

-

---

*Created: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, fileName), template, Encoding.UTF8);
    }

    /// <summary>
    /// Phase Summary íŒŒì¼ ìƒì„± (execute ì™„ë£Œ í›„)
    /// </summary>
    public static async Task CreatePhaseSummaryAsync(string workingDirectory, int phaseNumber, int planNumber, string summary)
    {
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);
        var fileName = $"phase-{phaseNumber}-{planNumber}-SUMMARY.md";

        var template = $@"# Phase {phaseNumber} - Plan {planNumber} Summary

## Execution Result

{summary}

## Changes Made

| File | Change Type | Description |
|------|-------------|-------------|
| | | |

## Commits

| Hash | Message |
|------|---------|
| | |

## Issues Encountered

- (ì—†ìŒ)

## Time Spent

- Start:
- End:
- Duration:

---

*Created: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, fileName), template, Encoding.UTF8);
    }

    /// <summary>
    /// Phase UAT íŒŒì¼ ìƒì„± (verify ë‹¨ê³„)
    /// </summary>
    public static async Task CreatePhaseUatAsync(string workingDirectory, int phaseNumber, string verificationResult)
    {
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);
        var fileName = $"phase-{phaseNumber}-UAT.md";

        var template = $@"# Phase {phaseNumber} - User Acceptance Test

## Verification Status: â³ Pending

## Observable Truths

| Truth | Status | Evidence |
|-------|--------|----------|
| | | |

## Artifacts Check

| Artifact | Exists | Substantial | Connected |
|----------|--------|-------------|-----------|
| | | | |

## Key Links Verified

| From | To | Status |
|------|----|--------|
| | | |

## Gaps Found

{verificationResult}

## Human Verification Needed

- [ ]

## Result

- **Status**: pending | passed | gaps_found | human_needed
- **Next Action**:

---

*Created: {DateTime.Now:yyyy-MM-dd HH:mm}*
";

        await File.WriteAllTextAsync(Path.Combine(planningPath, fileName), template, Encoding.UTF8);
    }

    /// <summary>
    /// STATE.md ì—…ë°ì´íŠ¸
    /// </summary>
    public static async Task UpdateStateAsync(string workingDirectory, int phase, string step, string? note = null)
    {
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);
        var statePath = Path.Combine(planningPath, "STATE.md");

        if (!File.Exists(statePath))
            return;

        var content = await File.ReadAllTextAsync(statePath);

        // Phase, Step ì—…ë°ì´íŠ¸
        content = System.Text.RegularExpressions.Regex.Replace(
            content,
            @"\*\*Phase\*\*: \d+",
            $"**Phase**: {phase}");

        content = System.Text.RegularExpressions.Regex.Replace(
            content,
            @"\*\*Step\*\*: \w+",
            $"**Step**: {step}");

        content = System.Text.RegularExpressions.Regex.Replace(
            content,
            @"\*\*Last Updated\*\*: .+",
            $"**Last Updated**: {DateTime.Now:yyyy-MM-dd HH:mm}");

        await File.WriteAllTextAsync(statePath, content, Encoding.UTF8);
    }

    /// <summary>
    /// í˜„ì¬ GSD ìƒíƒœ ì½ê¸°
    /// </summary>
    public static GsdConfig? LoadConfig(string workingDirectory)
    {
        try
        {
            var configPath = Path.Combine(workingDirectory, PlanningFolder, "config.json");
            if (!File.Exists(configPath))
                return null;

            var json = File.ReadAllText(configPath);
            return JsonSerializer.Deserialize<GsdConfig>(json);
        }
        catch
        {
            return null;
        }
    }

    /// <summary>
    /// GSD ì§„í–‰ ìƒí™© ìš”ì•½
    /// </summary>
    public static string GetProgressSummary(string workingDirectory)
    {
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);

        if (!Directory.Exists(planningPath))
            return "GSD ì›Œí¬í”Œë¡œìš°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. `/ts:init`ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.";

        var config = LoadConfig(workingDirectory);
        if (config == null)
            return ".planning/ í´ë”ëŠ” ìˆì§€ë§Œ config.jsonì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        var sb = new StringBuilder();
        sb.AppendLine($"# {config.ProjectName} - Progress");
        sb.AppendLine();
        sb.AppendLine($"- **Phase**: {config.CurrentPhase}");
        sb.AppendLine($"- **Step**: {config.CurrentStep}");
        sb.AppendLine($"- **Mode**: {config.ExecutionMode}");
        sb.AppendLine();

        // ì¡´ì¬í•˜ëŠ” íŒŒì¼ë“¤ í™•ì¸
        var files = Directory.GetFiles(planningPath, "*.md");
        sb.AppendLine("## Files");
        foreach (var file in files)
        {
            sb.AppendLine($"- {Path.GetFileName(file)}");
        }

        return sb.ToString();
    }

    /// <summary>
    /// STATE.mdì—ì„œ í˜„ì¬ ìƒíƒœ íŒŒì‹±
    /// </summary>
    public static GsdState? LoadState(string workingDirectory)
    {
        try
        {
            var statePath = Path.Combine(workingDirectory, PlanningFolder, "STATE.md");
            if (!File.Exists(statePath))
                return null;

            var content = File.ReadAllText(statePath);
            var state = new GsdState();

            // Phase íŒŒì‹±: **Phase**: 1
            var phaseMatch = Regex.Match(content, @"\*\*Phase\*\*:\s*(\d+)");
            if (phaseMatch.Success)
                state.CurrentPhase = int.Parse(phaseMatch.Groups[1].Value);

            // Step íŒŒì‹±: **Step**: discuss
            var stepMatch = Regex.Match(content, @"\*\*Step\*\*:\s*(\w+)");
            if (stepMatch.Success)
                state.CurrentStep = stepMatch.Groups[1].Value.ToLower();

            // Last Updated íŒŒì‹±
            var updatedMatch = Regex.Match(content, @"\*\*Last Updated\*\*:\s*(.+)");
            if (updatedMatch.Success && DateTime.TryParse(updatedMatch.Groups[1].Value, out var dt))
                state.LastUpdated = dt;

            return state;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[GsdWorkflowService] LoadState failed: {ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// Phase ë¬¸ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    /// </summary>
    public static List<string> GetPhaseFiles(string workingDirectory, int phaseNumber)
    {
        var result = new List<string>();
        var planningPath = Path.Combine(workingDirectory, PlanningFolder);

        if (!Directory.Exists(planningPath))
            return result;

        var pattern = $"phase-{phaseNumber}-*.md";
        var files = Directory.GetFiles(planningPath, pattern);

        foreach (var file in files)
        {
            result.Add(Path.GetFileName(file));
        }

        return result;
    }

    /// <summary>
    /// Phase ë¬¸ì„œ ë‚´ìš© ì½ê¸°
    /// </summary>
    /// <param name="workingDirectory">ì‘ì—… ë””ë ‰í† ë¦¬</param>
    /// <param name="phaseNumber">Phase ë²ˆí˜¸</param>
    /// <param name="documentType">ë¬¸ì„œ ìœ í˜• (CONTEXT, PLAN, SUMMARY, UAT)</param>
    /// <param name="planNumber">Plan ë²ˆí˜¸ (PLAN, SUMMARYì¸ ê²½ìš°)</param>
    public static async Task<string?> ReadPhaseDocumentAsync(
        string workingDirectory,
        int phaseNumber,
        string documentType,
        int planNumber = 1)
    {
        try
        {
            var planningPath = Path.Combine(workingDirectory, PlanningFolder);
            string fileName;

            switch (documentType.ToUpper())
            {
                case "CONTEXT":
                    fileName = $"phase-{phaseNumber}-CONTEXT.md";
                    break;
                case "PLAN":
                    fileName = $"phase-{phaseNumber}-{planNumber}-PLAN.md";
                    break;
                case "SUMMARY":
                    fileName = $"phase-{phaseNumber}-{planNumber}-SUMMARY.md";
                    break;
                case "UAT":
                    fileName = $"phase-{phaseNumber}-UAT.md";
                    break;
                default:
                    return null;
            }

            var filePath = Path.Combine(planningPath, fileName);
            if (!File.Exists(filePath))
                return null;

            return await File.ReadAllTextAsync(filePath);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[GsdWorkflowService] ReadPhaseDocument failed: {ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// Phase ë¬¸ì„œ ì €ì¥
    /// </summary>
    public static async Task<bool> SavePhaseDocumentAsync(
        string workingDirectory,
        int phaseNumber,
        string documentType,
        string content,
        int planNumber = 1)
    {
        try
        {
            var planningPath = Path.Combine(workingDirectory, PlanningFolder);
            string fileName;

            switch (documentType.ToUpper())
            {
                case "CONTEXT":
                    fileName = $"phase-{phaseNumber}-CONTEXT.md";
                    break;
                case "PLAN":
                    fileName = $"phase-{phaseNumber}-{planNumber}-PLAN.md";
                    break;
                case "SUMMARY":
                    fileName = $"phase-{phaseNumber}-{planNumber}-SUMMARY.md";
                    break;
                case "UAT":
                    fileName = $"phase-{phaseNumber}-UAT.md";
                    break;
                default:
                    return false;
            }

            var filePath = Path.Combine(planningPath, fileName);
            await File.WriteAllTextAsync(filePath, content, Encoding.UTF8);
            return true;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[GsdWorkflowService] SavePhaseDocument failed: {ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// Planì—ì„œ íƒœìŠ¤í¬ ëª©ë¡ ì¶”ì¶œ ("- [ ] Task" íŒ¨í„´)
    /// </summary>
    public static List<GsdTask> ExtractTasksFromPlan(string planContent)
    {
        var tasks = new List<GsdTask>();

        if (string.IsNullOrEmpty(planContent))
            return tasks;

        // - [ ] ë˜ëŠ” - [x] íŒ¨í„´ ê²€ìƒ‰
        var matches = Regex.Matches(planContent, @"^-\s*\[([ xX])\]\s*(.+)$", RegexOptions.Multiline);

        foreach (Match match in matches)
        {
            var isCompleted = match.Groups[1].Value.Trim().ToLower() == "x";
            var content = match.Groups[2].Value.Trim();

            tasks.Add(new GsdTask
            {
                Content = content,
                IsCompleted = isCompleted
            });
        }

        return tasks;
    }

    /// <summary>
    /// GsdStep ì—´ê±°í˜•ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
    /// </summary>
    public static string StepToString(GsdStep step)
    {
        return step switch
        {
            GsdStep.Discuss => "discuss",
            GsdStep.Plan => "plan",
            GsdStep.Execute => "execute",
            GsdStep.Verify => "verify",
            _ => "discuss"
        };
    }

    /// <summary>
    /// ë¬¸ìì—´ì„ GsdStep ì—´ê±°í˜•ìœ¼ë¡œ ë³€í™˜
    /// </summary>
    public static GsdStep StringToStep(string step)
    {
        return step.ToLower() switch
        {
            "discuss" => GsdStep.Discuss,
            "plan" => GsdStep.Plan,
            "execute" => GsdStep.Execute,
            "verify" => GsdStep.Verify,
            _ => GsdStep.Discuss
        };
    }

    /// <summary>
    /// config.json ì—…ë°ì´íŠ¸
    /// </summary>
    public static async Task UpdateConfigAsync(string workingDirectory, int phase, GsdStep step)
    {
        try
        {
            var config = LoadConfig(workingDirectory);
            if (config == null) return;

            config.CurrentPhase = phase;
            config.CurrentStep = StepToString(step);

            var configPath = Path.Combine(workingDirectory, PlanningFolder, "config.json");
            var json = JsonSerializer.Serialize(config, new JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(configPath, json);

            // STATE.mdë„ ì—…ë°ì´íŠ¸
            await UpdateStateAsync(workingDirectory, phase, StepToString(step));
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[GsdWorkflowService] UpdateConfig failed: {ex.Message}");
        }
    }

    /// <summary>
    /// Plan ë‚´ìš©ì„ PRD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (Executeìš©)
    /// </summary>
    public static string ConvertPlanToPrd(string planContent, int phaseNumber)
    {
        if (string.IsNullOrEmpty(planContent))
            return string.Empty;

        var sb = new StringBuilder();
        sb.AppendLine($"# Phase {phaseNumber} Implementation");
        sb.AppendLine();
        sb.AppendLine("## Tasks from Plan");
        sb.AppendLine();
        sb.AppendLine(planContent);
        sb.AppendLine();
        sb.AppendLine("## Instructions");
        sb.AppendLine("- Implement each task marked with [ ]");
        sb.AppendLine("- Commit after completing each task");
        sb.AppendLine("- When all tasks are done, output: [RALPH_COMPLETE]");

        return sb.ToString();
    }

    /// <summary>
    /// Planì—ì„œ AgentTask ëª©ë¡ ì¶”ì¶œ
    /// </summary>
    public static List<AgentTask> ExtractAgentTasksFromPlan(string planContent)
    {
        var agentTasks = new List<AgentTask>();
        var gsdTasks = ExtractTasksFromPlan(planContent);

        foreach (var task in gsdTasks)
        {
            agentTasks.Add(new AgentTask
            {
                Description = task.Content,
                Status = task.IsCompleted ? AgentTaskStatus.Completed : AgentTaskStatus.Pending
            });
        }

        return agentTasks;
    }

    /// <summary>
    /// ì‹¤í–‰ ëª¨ë“œë¥¼ config.jsonì— ì €ì¥
    /// </summary>
    public static async Task UpdateExecutionModeAsync(string workingDirectory, ExecutionMode mode)
    {
        try
        {
            var config = LoadConfig(workingDirectory);
            if (config == null) return;

            config.ExecutionMode = mode switch
            {
                ExecutionMode.Interactive => "interactive",
                ExecutionMode.Yolo => "yolo",
                ExecutionMode.EcoMode => "eco",
                ExecutionMode.Pipeline => "pipeline",
                ExecutionMode.Swarm => "swarm",
                ExecutionMode.Expert => "expert",
                _ => "interactive"
            };

            var configPath = Path.Combine(workingDirectory, PlanningFolder, "config.json");
            var json = JsonSerializer.Serialize(config, new JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(configPath, json);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[GsdWorkflowService] UpdateExecutionMode failed: {ex.Message}");
        }
    }

    /// <summary>
    /// config.jsonì—ì„œ ì‹¤í–‰ ëª¨ë“œ ë¡œë“œ
    /// </summary>
    public static ExecutionMode LoadExecutionMode(string workingDirectory)
    {
        var config = LoadConfig(workingDirectory);
        if (config == null) return ExecutionMode.Interactive;

        return config.ExecutionMode?.ToLower() switch
        {
            "interactive" => ExecutionMode.Interactive,
            "yolo" => ExecutionMode.Yolo,
            "eco" => ExecutionMode.EcoMode,
            "pipeline" => ExecutionMode.Pipeline,
            "swarm" => ExecutionMode.Swarm,
            "expert" => ExecutionMode.Expert,
            _ => ExecutionMode.Interactive
        };
    }
}
